<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">

    <title>Admin | Manage Users</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/jquery-ui.css" rel="stylesheet">
    <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <link href="/assets/css/style.css" rel="stylesheet">
    <link href="/assets/css/style-responsive.css" rel="stylesheet">
    <link href="/assets/css/sweetalert.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-select.css" rel="stylesheet">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/datatables.min.css"/>
    <style>
    .jstree-wholerow-ul {
      font-size: 18px;
    }
    #productsTable_filter {
      display: none;
    }
    input.error {
      border: 2px solid red;
    }
    input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
      }
      tr.dark {
        background: black;
        color: white;
        font-weight: bold;
      }
      tr.dark td {
        background: black !important;
        color: white !important;
        font-weight: bold !important;
      }

      .pump > table tr td, table.dataTable tr td {
            font-size: 15px;
      }
      .oil > table tr td {
            font-size: 15px;
      }
      .pump > table tr td:not(:first-of-type), table.dataTable tr td:not(:first-of-type) {
        vertical-align: bottom;
        text-align: right;
      }
      .oil > table tr td:not(:first-of-type) {
        vertical-align: bottom;
        text-align: right;
      }
      th {
        font-size:15px;
        font-weight:bold;
      }
      tr th:not(:first-of-type) {
        text-align: right;
      }
      table .form-control {
        text-align: end;
      }
      .oil > table tr th:not(:first-of-type) {
        vertical-align: bottom;
        text-align: right;
      }
      .oil > table tr td input, table.dataTable tr td input {
        vertical-align: bottom;
        text-align: right;
      }
      .pump > table tr td:first-of-type {
        vertical-align: bottom;
      }
      span.multiselect-selected-text {
        width:220px;
      }
      .multiselect.dropdown-toggle.btn.btn-default {
        width:220px;
        min-width:220px;
      }
      div.pump {
        width: 600px;
        max-width: 600px;
        min-width: 600px;
        height: 320px;
        max-height: 320px;
        min-height: 320px;
        border: 1px solid;
        padding: 0;
        float:left;
        box-shadow: 3px 5px #888888;
        border-radius: 10px;
        margin-bottom : 10px;
        background: white;
        margin-left: 5px;
        position: relative;
      }
      div.pump span {
        color: white;
        position: absolute;
        top: 2px;
        right: 10px;
        cursor: pointer;
        font-size: 18px;
      }
      div.pump h4 {
        margin-block-start: 0em;
        background: black;
        color: white;
        padding-top: 5px;
        padding: 7px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        padding-bottom: 5px;
        font-weight: bold;
        text-align: center;
      }
      div.pump select.form-control {
        margin-bottom: 5px;

      }
      div.service {
        width: 600px;
        max-width: 600px;
        min-width: 600px;
        border: 1px solid;
        padding: 0;
        float:left;
        box-shadow: 3px 5px #888888;
        border-radius: 10px;
        margin-bottom : 10px;
        background: white;
        margin-left: 5px;
        position: relative;
        padding-bottom: 5px;
      }
      div.pump span,div.service span {
        color: white;
        position: absolute;
        top: 2px;
        right: 10px;
        cursor: pointer;
        font-size: 18px;
      }
      div.pump h4, div.service h4  {
        margin-block-start: 0em;
        background: black;
        color: white;
        padding-top: 5px;
        padding: 7px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        padding-bottom: 5px;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>

  <body  onunload="delete localStorage.referer">

  <section id="container" >
      <header class="header black-bg">
              <div class="sidebar-toggle-box">
                  <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
              </div>
            <a href="#" class="logo"><b>Admin Dashboard</b></a>
            <div class="nav notify-row" id="top_menu">
            </div>
            <div class="top-menu">
            	<ul class="nav pull-right top-menu">
                  <li id="backtoadmin" style="display:none;"><a class="logout" style="background:white;color:black;" href="/admin/admin.html">Back to Admin</a></li>
                  <li><a class="logout" style="background:white;color:black;" onclick="window.location.href = '/reports';">Reports</a></li>
                <li><a class="logout" onclick="delete localStorage.user;window.location.href = '/user/index.html';">Logout</a></li>
            	</ul>
            </div>
        </header>
      <aside>
          <div id="sidebar"  class="nav-collapse ">
              <ul class="sidebar-menu" id="nav-accordion">
            	   <h5 class="centered"></h5>
                    <li class="sub-menu">
                      <a href="javascript:switchTo('changePassword');" class="active">
                          <i class="fa fa-users"></i>
                          <span>Change Password</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('fuelSales');" >
                          <i class="fa fa-users"></i>
                          <span>Sales - Fuel</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('oilSales');" >
                          <i class="fa fa-users"></i>
                          <span>Sales - Oil & Lottery</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('serviceSales');" >
                          <i class="fa fa-users"></i>
                          <span>Sales - Services</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('products');" >
                          <i class="fa fa-users"></i>
                          <span>Products</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('fuelDelivery');" >
                          <i class="fa fa-users"></i>
                          <span>Fuel Delivery</span>
                      </a>
                    </li>
                    <li class="menu">
                      <a href="javascript:switchTo('payments');" >
                          <i class="fa fa-users"></i>
                          <span>Payments</span>
                      </a>
                    </li>
                </ul>
          </div>
      </aside>
      <section id="main-content">
          <section page class="wrapper" id="changePassword">
            <div class="container" style="width:50%;padding:20px;">
                <form id="passwordChange" >
                  <div class="form-group">
                    <label for="currentPassword">Current password</label>
                    <input type="password" class="form-control" id="currentPassword" name="currentPassword" placeholder="Enter Current Password">
                  </div>
                  <div class="form-group">
                    <label for="password">New password</label>
                    <input type="password" class="form-control" id="password" name="password" placeholder="Enter New Password">
                  </div>
                  <div class="form-group">
                    <label for="confirmPassword">Confirm New password</label>
                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm New Password">
                  </div>
                </form>
                <div class="modal-footer">
                  <button type="button" onclick="$('#passwordChange').submit();" class="btn btn-primary">Save changes</button>

                </div>
            </div>
          </section>




         <section page class="wrapper" id="fuelSales" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:420px;">
              <table><tr><td>
              <label for="salesDate">Select date</label>
              <input type="text" class="form-control" id="salesDate" style="width:200px;">
            </td><td><button onclick="sendFuel();" class="btn btn-primary btn-large" style="margin-left:5px;margin-top:22px;">Submit to Admin</button></td></tr></table>
            </div>
            <h2 totalsales>Total fuel sales: &#163;0.00</h2>
            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;" id="saleSheet">

            </div>
         </section>

         <section page class="wrapper" id="oilSales" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:420px;">

            <table><tr><td>
              <label for="oilSalesDate">Select date</label>
              <input type="text" class="form-control" id="oilSalesDate" style="width:200px;">
            </td><td><button onclick="sendOil();" class="btn btn-primary btn-large" style="margin-left:5px;margin-top:22px;">Submit to Admin</button></td></tr></table>
          </div>
            <h2 totaloilsales>Total oil & lottery sales: &#163;0.00</h2>
            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;"  class='oil' id="oilSaleSheet">
              <table class="table table-striped table-advance table-hover" id="oilSalesTable">
                <h4><i class="fa fa-angle-right"></i> All User Details </h4>
                <hr>
                  <thead>
                  <tr>
                      <th>Name</th>
                      <th style='width:100px;'>Start</th>
                      <th style='width:100px;'>Input</th>
                      <th style='width:100px;'>End</th>
                      <th>Price</th>
                      <th>Discount</th>
                      <th>Sale price</th>

                      <th>Sold</th>
                      <th>Value</th>
                  </tr>
                  </thead>
                  <tbody>

                  </tbody>
              </table>
            </div>
         </section>
         <section page class="wrapper" id="serviceSales" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:220px;">
              <table><tr><td>
                <label for="servicesSalesDate">Select date</label>
                <input type="text" class="form-control" id="serviceSalesDate" style="width:200px;">
              </td><td><button onclick="sendServices();" class="btn btn-primary btn-large" style="margin-left:5px;margin-top:22px;">Submit to Admin</button></td></tr></table>

            </div>
            <h2 totalservicesales>Total services sales: &#163;0.00</h2>
            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;" id="serviceSaleSheet">

            </div>
         </section>

         <section page class="wrapper" id="fuelDelivery" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:220px;">
              <label for="fuelDeliveryDate">Select date</label>
              <input type="text" class="form-control" id="fuelDeliveryDate" style="width:200px;">
            </div>

            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;" id="fuelDeliverySheet">
              <table class="table table-striped table-advance table-hover" id="fuelDeliveryTable">
                <h4><i class="fa fa-angle-right"></i> Fuel delivery </h4>
                <hr>
                  <thead>
                  <tr>
                      <th></th>
                      <th>Grade</th>
                      <th>Volume</th>
                  </tr>
                  </thead>
                  <tbody>

                  </tbody>
              </table>
            </div>
         </section>
         <section page class="wrapper" id="payments" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:220px;">
              <label for="paymentDate">Select date</label>
              <input type="text" class="form-control" id="paymentDate" style="width:200px;">
            </div>

            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;" id="paymentSheet">
              <table class="table table-striped table-advance table-hover" id="paymentTable">
                <h4><i class="fa fa-angle-right"></i> Payments </h4>
                <hr>
                  <thead>
                  <tr>
                      <th></th>
                      <th>Method</th>
                      <th>Volume</th>
                  </tr>
                  </thead>
                  <tbody>

                  </tbody>
              </table>
            </div>
         </section>
         <section page class="wrapper" id="products" style="display:none;padding: 20px;">
            <div style="margin:20px auto;width:220px;">
              <label for="productSalesDate">Select date</label>
              <input type="text" class="form-control" id="productSaleDate" style="width:200px;">
            </div>
            <div style="width:100%;max-width:100%;display: inline-block;margin-top:10px;margin-left: -5px;" id="productSaleSheet">
              <div class="row">
                <div  class="col-lg-4">
                  <div id="products_jstree">

                   </div>
                </div>
                <div class="col-lg-8">
                  <table class="table table-striped table-advance table-hover" style="min-width:100%;" id="productsTable">
                    <h4><i class="fa fa-angle-right"></i> Products belongs to selected category </h4>
                    <hr>
                      <thead>
                        <tr>
                          <th></th>
                          <th></th>
                          <th>Name</th>
                          <th style="text-align:left;">Sales</th>
                        </tr>
                      </thead>
                      <tbody>

                      </tbody>
                  </table>
                </div>
              </div>
            </div>
         </section>
    </section>
    <div class="modal" tabindex="-1" role="dialog" id="modalForm">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">User data</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
              <button type="button" onclick="$('#userForm').submit();" class="btn btn-primary">Save changes</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
    </div>
    <script src="/assets/js/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <script class="include" type="text/javascript" src="/assets/js/jquery.dcjqaccordion.2.7.js"></script>
    <script src="/assets/js/jquery.scrollTo.min.js"></script>
    <script src="/assets/js/jquery.nicescroll.js" type="text/javascript"></script>
    <script src="/assets/js/common-scripts.js"></script>
    <script type="text/javascript" src="/assets/js/api.js"></script>
    <script type="text/javascript" src="/assets/js/sweetalert2.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.validate.js"></script>
    <script type="text/javascript" src="/assets/js/underscore.js"></script>
    <link rel="stylesheet" href="/assets/css/bootstrap-select.css" type="text/css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <script type="text/javascript" src="/assets/js/bootstrap-select.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
   <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/datatables.min.js"></script>

  <script type="text/javascript">
  if (localStorage.user === undefined) {
      window.location.href = "/user/index.html";
  }
  try {
    var user = $.parseJSON(localStorage.user);
  } catch(err) {

  }
  // window.history.replaceState( {} , user.site, user.site + '.' + window.location.host );
    var yesterday = new Date(Date.now() - 864e5); // 864e5 == 86400000 == 24*60*60*1000
    yesterday.setHours(00);
    yesterday.setMinutes(00);
    yesterday.setSeconds(00);
    var saleDate = null;
    var saleDateNow = null;
    var workingDate = null;
    var workingDateShort = null;
    var serviceSaleDate = null;
    var serviceSaleDateNow = null;
    var productSaleDate = null;
    var productSaleDateNow = null;
    var oilSaleDate = null;
    var oilSaleDateNow = null;
    var fuelDeliveryDate = null;
    var fuelDeliveryDateNow = null;
    var siteConfiguration = null;
    var paymentDate = null;
    var siteOil = {};
    url =  "http://samygroups.co.uk/admin/";
    var validator = null;
    function initSalesSheet() {
        if (siteConfiguration.nozzles.length == 0) {
          return;
        }
        $("#salesSheet").html("");
        var dEnabled = false;
        var cdt = new Date(saleDate);
        var wdt = new Date(yesterday);
        var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();

        if (sDate && (new Date()).getHours() < 12) {
          dEnabled = true;
        }

          $.each(siteConfiguration.pumps, function() {
            var pmp = this;
            var ths = this;

            var hasNozzles = (_.filter(siteConfiguration.nozzles, function(pump) {
              return (pump.pumpid == ths.pumpid );
            }).length > 0);

            if (hasNozzles && ((new Date(ths.date_added)) <= (new Date(saleDate)))) {
                var nozzles = _.filter(siteConfiguration.nozzles, function(pump) {
                  return (pump.pumpid == ths.pumpid);
                });

                var did = "pumpDiv_" + this.pumpid;
                var tid = "pumpTable_" + this.pumpid;
                var $dv = $("<div pump id='" + did + "' class='pump' siteid='" + this.siteid + "' pumpid='" + this.pumpid + "'></div>").appendTo($("#saleSheet"));
                $("<h4>" + this.label + "</h4>").appendTo($("#" + did));
                var $tb = $("<table class='table table-striped table-bordered'></table>");
                var $tbd = $("<thead class='thead-dark'></thead>").appendTo($tb);
                var $thd = $("<tr><th>Grade</th><th>Start</th><th style='width:100px;'>Sold</th><th>End</th><th>Price</th><th style='width:100px;'>Value</th></tr>");
                var $bdy = $("<tbody></tbody>").appendTo($tb);
                $thd.appendTo($tbd);
                var prices = siteConfiguration.fuelprices;
                var start = [];
                $.each(nozzles, function(ind) {
                    var ths = this;
                    var p = _.filter(prices, function(f) {
                      return (ths.fuelid == f.fuelid)
                    })[0].price;
                    lastsale = [];

                    var last = _.filter(siteConfiguration.lastsale, function(sls) {
                      return (ths.nozzleid == sls.nozzleid)
                    });
                    start = _.filter(siteConfiguration.fuelsales, function(sls) {
                      return (ths.nozzleid == sls.nozzleid)
                    });
                    var s = null;
                    if (start.length == 0) {
                      s = ths.start;
                    } else {
                      s = start[0].end;
                    }
                    if (s == "") {
                      s = 0;
                    }

                    if (start.length == 0 &&  last.length == 0) {
                      var $sls = $("<tr fuelid='" + ths.fuelid + "' nozzleid='" + ths.nozzleid + "' pumpid='" + ths.pumpid + "'><td>" + this.grade + "</td><td>" + s + "</td><td></td><td><input fuelenter onchange='calculateSale(this);' style='width:80px;' class='form-control' type='number' /></td><td>" + p + "</td><td></td></tr>");
                    }
                    if (start.length > 0 && last.length == 0)  {
                      var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(start[0].value));
                      var $sls = $("<tr fuelid='" + ths.fuelid + "' nozzleid='" + ths.nozzleid + "' pumpid='" + ths.pumpid + "'><td>" + this.grade + "</td><td>" + start[0].start + "</td><td>" + start[0].counter + "</td><td><input fuelenter value='" + start[0].end + "' onchange='calculateSale(this);' style='width:80px;' class='form-control' type='number' /></td><td>" + start[0].price + "</td><td total='" + start[0].value + "'>" + fmt + "</td></tr>");
                    }
                    if (start.length == 0 && last.length > 0)  {
                      var $sls = $("<tr fuelid='" + ths.fuelid + "' nozzleid='" + ths.nozzleid + "' pumpid='" + ths.pumpid + "'><td>" + this.grade + "</td><td>" + last[0].end + "</td><td></td><td><input fuelenter onchange='calculateSale(this);' style='width:80px;' class='form-control' type='number' /></td><td>" + p + "</td><td></td></tr>");
                    }
                    $sls.appendTo($bdy);
                    if ((ind + 1) == nozzles.length) {
                      $("<tr totalrow class='dark'><td>Total</td><td></td><td></td><td></td><td></td><td></td>0.00</tr>").appendTo($bdy);
                    }
                });

                $tb.appendTo($("#" + did));

                if (!dEnabled && user.user_type == "0") {
                  $("#" + did).find("input").prop("disabled", true);
                }
                if (pmp.active == "0" && start.length == 0) {
                  $("#" + did).remove();
                } else {
                  tableTotal($tb);
                }
            }
          });
      }
      function tableTotal($tb) {
        var t = 0;
        $.each($tb.find("[total]"), function() {
          t += parseFloat($(this).attr("total"));
        });
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(t);
        $tb.find("[totalrow]").find("td").eq(5).html(fmt);
        $tb.find("[totalrow]").find("td").eq(5).attr("ttl", t);
        var gt = 0;
        $.each($("[ttl]"), function() {
          gt += parseFloat($(this).attr("ttl"));
        });
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(gt);
        $("[totalsales]").html("Total fuel sales: " + fmt);
      }
      function tableServicesTotal($tb) {
        var t = 0;
        $.each($tb.find("[total]"), function() {
          t += parseFloat($(this).attr("total"));
        });
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(t);
        $tb.find("[totalrow]").find("td").eq(5).html(fmt);
        $tb.find("[totalrow]").find("td").eq(5).attr("ttl", t);
        var gt = 0;
        $.each($("[ttl]"), function() {
          gt += parseFloat($(this).attr("ttl"));
        });
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(gt);
      //  $("[totalservicesales]").html("Total services sales: " + fmt);
      }
      function calculateSale(el) {
        var $el = $(el);
        var total = 0;
        var $tr = $el.closest("tr");
        var start = parseInt($tr.find("td").eq(1).html());
        if ($el.val() < start && user.user_type == "0") {
          swal({
            type: "error",
            text: "Ending value can not be less starting!"
          })
          return;
        }
        if ($el.val() < start && user.user_type == "1") {
          var sold = parseFloat($tr.find("td").eq(2).html());
          var price = parseFloat($tr.find("td").eq(4).html());
          var value = price * sold;
        } else {
          var sold = $el.val() - start;
          var price = parseFloat($tr.find("td").eq(4).html());
          var value = price * sold;
        }
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(value);
        var ttl = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(total);
        $tr.find("td").eq(5).html(fmt);
        $tr.find("td").eq(5).attr("total", value);
        $tr.find("td").eq(2).html(sold);
        tableTotal($el.closest("table"));
        var obj = {
          siteid: user.siteid,
          date: saleDate,
          nozzleid: $tr.attr("nozzleid"),
          pumpid: $tr.attr("pumpid"),
          fuelid: $tr.attr("fuelid"),
          start: $tr.find("td").eq(1).html(),
          counter: $tr.find("td").eq(2).html(),
          end: $tr.find("td").eq(3).find("input").val(),
          price: price,
          value: value
        }
        api.call("insertOrUpdateSale", function(res) {}, obj, {});
      }


  function initServiceSalesSheet() {
      $("#serviceSaleSheet").html("");
      var dEnabled = false;
      var cdt = new Date(serviceSaleDate);
      var wdt = new Date(yesterday);
      var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();

      if (sDate && (new Date()).getHours() < 12) {
        dEnabled = true;
      }

      if (siteConfiguration.services.length == 0) {
        return;
      }
      $.each(siteConfiguration.services, function() {
          var srv = this;
          var ths = this;
          var hasCounters = (_.filter(siteConfiguration.counters, function(service) {
            return (service.serviceid == ths.serviceid);
          }).length > 0);
          if (hasCounters) {
              var counters = _.filter(siteConfiguration.counters, function(service) {
                return (service.serviceid == ths.serviceid);
              });
              var did = "serviceDiv_" + this.serviceid;
              var tid = "serviceTable_" + this.serviceid;
              var $dv = $("<div service id='" + did + "' class='pump' style='height:unset;max-height:unset;min-height:unset;' siteid='" + this.siteid + "' serviceid='" + this.serviceid + "'></div>").appendTo($("#serviceSaleSheet"));
              $("<h4>" + this.label + "</h4>").appendTo($("#" + did));
              var $tb = $("<table class='table table-striped table-bordered'></table>");
              var $tbd = $("<thead class='thead-dark'></thead>").appendTo($tb);
              var $thd = $("<tr><th>Label</th><th>Start</th><th style='width:100px;'>Sold</th><th>End</th><th>Price</th><th style='width:100px;'>Value</th></tr>");
              var $bdy = $("<tbody></tbody>").appendTo($tb);
              $thd.appendTo($tbd);
              var start = [];
              $.each(counters, function(ind) {
                  var ths = this;
                  lastservice = [];

                  var lastservice = _.filter(siteConfiguration.lastservicesale, function(sls) {
                    return (ths.counterid == sls.counterid)
                  });

                  startservice = _.filter(siteConfiguration.servicesales, function(sls) {
                    return (ths.counterid == sls.counterid)
                  });
                  var ss = null;
                  var sstart = [];
                  if (startservice.length == 0) {
                    ss = ths.start;
                  } else {
                    ss = startservice[0].end;
                  }
                  if (ss == "") {
                    ss = 0;
                  }

                  if (startservice.length == 0 && lastservice.length == 0) {
                    var $sls = $("<tr serviceid='" + ths.serviceid + "' counterid='" + ths.counterid + "'><td>" + this.label + "</td><td>" + ss + "</td><td></td><td style='text-align:right;'><input style='float:right;width:80px;' onchange='calculateServiceSale(this);' style='width:80px;' class='form-control' type='number' /></td><td>" + ths.price + "</td><td></td></tr>");
                  }
                  if (startservice.length > 0 && lastservice.length == 0)  {
                    var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(startservice[0].value));
                    var $sls = $("<tr counterid='" + ths.counterid + "' serviceid='" + ths.serviceid + "'><td>" + this.label + "</td><td>" + startservice[0].start + "</td><td>" + startservice[0].counter + "</td><td style='width:80px;text-align:right;'><input style='float:right;width:80px;' value='" + startservice[0].end + "' onchange='calculateServiceSale(this);' style='width:80px;' class='form-control' type='number' /></td><td>" + startservice[0].price + "</td><td total='" + startservice[0].value + "'>" + fmt + "</td></tr>");
                  }
                  if (startservice.length == 0 && lastservice.length > 0)  {
                    var $sls = $("<tr counterid='" + ths.counterid + "' serviceid='" + ths.serviceid + "'><td>" + this.label + "</td><td>" + lastservice[0].end + "</td><td></td><td><input  style='float:right;width:80px;' onchange='calculateServiceSale(this);'  class='form-control' type='number' /></td><td>" + ths.price + "</td><td></td></tr>");
                  }
                  $sls.appendTo($bdy);
                  if ((ind + 1) == counters.length) {
                    $("<tr totalrow class='dark'><td>Total</td><td></td><td></td><td></td><td></td><td></td>0.00</tr>").appendTo($bdy);
                  }
              });

            $tb.appendTo($("#" + did));
            if (!dEnabled && user.user_type != "1") {
              $("#" + did).find("input").prop("disabled", true);
            }

            if (srv.active == "0" && start.length == 0) {
              $("#" + did).remove();
            } else {
              tableServicesTotal($tb);
            }
        }
    });
  }
    function switchTo(page) {

      $("[page]").hide();
      $("#" + page).show();
      if (page == "fuelSales") {
        if (siteConfiguration.nozzles.length == 0) {
          swal({
            type: "error",
            text: "You have not nozzle(s) configured. Please contact admin."
          })
          switchTo("changePassword");
          return;
        }
        if (siteConfiguration.fuelprices.length == 0) {
          swal({
            type: "error",
            text: "You have'not price list for this date. Please contact admin."
          })
          switchTo("changePassword");
          return;
        }
      }

    }
    var oils = null;
    var tanks = null;
    var pMethods = [];
    $(document).ready(function() {

    if (localStorage.user === undefined) {
      window.location.href = "/user/index.html"
    }
      if (user.user_type == "1") {
        $("#backtoadmin").show();
      } else {
        $("#backtoadmin").hide();
      }
      api.call("getSiteFuels",function(res) {
        tanks = res.records;
      }, { siteid: user.siteid },{});

      api.call("getPayments",function(res) {
        pMethods = res;
      }, { siteid: user.siteid },{});

      $('#products_jstree').jstree({
          'core' : {
        'data' : {
                'url' : '/admin/product_categories.php?operation=get_node',
                'data' : function (node) {
                  return { 'id' : node.id };
                },
                "dataType" : "json"
              }
              ,'check_callback' : true,
              'themes' : {
                'responsive' : false
              }
        },
        'plugins' : ['state','wholerow']
          }).on('select_node.jstree', function (e, data) {
            selectCategory = data.node.id;

              var ww = setInterval(function() {
                if (productsTable !== undefined) {
                  clearInterval(ww);
                  productsTable
                    .column( 1 )
                    .search( selectCategory )
                    .draw();
                  setTimeout(function() {
                    productsTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                      var tr = this.node();
                      var d = this.data();
                      if (pSales[d.id] !== undefined) {
                        d.sales = pSales[d.id]["sales"];
                        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(pSales[d.id]["sales"]));
                        tr.getElementsByTagName("INPUT")[0].value = fmt;
                      }
                    });
                  }, 500);
                }
              }, 100)

          });


      user = $.parseJSON(localStorage.user);

    /*  if ( user.user_type != "0") {
        window.location.href = "/index.html";
      }*/
      swal.setDefaults({
        allowOutsideClick: false,
        allowEscapeKey: false,
        showCloseButton: false,
        buttonsStyling: false,
        confirmButtonClass: 'btn btn-primary',
        cancelButtonClass: 'btn btn-danger'
      });

      $("a.logo").html(user.site);
      $('#salesDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#salesDate').datepicker('getDate');
          dt.setHours((new Date()).getHours());
          saleDateNow = dt;

          $("[totalsales]").html("Total fuel sales: &#163;0.00");
          saleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          var obj = {
            siteid: user.siteid,
            date: saleDate
          }
          api.call("getSiteConfiguration", function(res) {
            siteConfiguration = res;
              $("#saleSheet").html("");
              initSalesSheet();
          }, obj, {});
        }
      });

      $('#serviceSalesDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#serviceSalesDate').datepicker('getDate');
          dt.setHours(new Date().getHours());
          $("[totalservicesales]").html("Total services sales: &#163;0.00");
          serviceSaleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          var obj = {
            siteid: user.siteid,
            date: serviceSaleDate
          }
          api.call("getSiteConfiguration", function(res) {
            siteConfiguration = res;

              $("#saleSheet").html("");
              initServiceSalesSheet();
          }, obj, {});
        }
      });

      $('#fuelDeliveryDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#fuelDeliveryDate').datepicker('getDate');
          dt.setHours(new Date().getHours());
          fuelDeliveryDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          var obj = {
            siteid: user.siteid,
            date: fuelDeliveryDate
          }
          setFuelDelivery();
        }
      });

      $('#paymentDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#paymentDate').datepicker('getDate');
          dt.setHours(new Date().getHours());
          paymentDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          var obj = {
            siteid: user.siteid,
            date: paymentDate
          }

          setPayments();
        }
      });
      $('#oilSalesDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#oilSalesDate').datepicker('getDate');
          dt.setHours(new Date().getHours());
          oilSaleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          setOilSales();
        }
      });

      $('#productSaleDate').datepicker({
        maxDate: (user.user_type == "1") ? "+0D" : "-1D",
        onSelect: function(dateText) {
          var dt = $('#productSaleDate').datepicker('getDate');
          dt.setHours(new Date().getHours());
          productSaleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
          setProductSales();
        }
      });

      $('#productSaleDate').datepicker('setDate', 'yesterday');
      var dt = $('#productSaleDate').datepicker('getDate');
      dt.setHours(new Date().getHours());
      productSaleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
      setProductSales();

      $('#fuelDeliveryDate').datepicker('setDate', 'yesterday');
      var dt = $('#fuelDeliveryDate').datepicker('getDate');
      dt.setHours(new Date().getHours());
      fuelDeliveryDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
      setFuelDelivery();

      $('#paymentDate').datepicker('setDate', 'yesterday');
      var dt = $('#paymentDate').datepicker('getDate');
      dt.setHours(new Date().getHours());
      paymentDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
      setPayments();


      $('#salesDate').datepicker('setDate', 'yesterday');
      var dt = $('#salesDate').datepicker('getDate');
      saleDateNow = dt;
      saleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
      workingDateShort = new Date(saleDate);
      workingDate = dt;

      $('#serviceSalesDate').datepicker('setDate', 'yesterday');
      var dt = $('#serviceSalesDate').datepicker('getDate');
      dt.setHours(new Date().getHours());
      serviceSaleDate = dt.getFullYear() + "-" + (dt.getMonth() + 1).toString().padStart(2, "0") + "-" + dt.getDate().toString().padStart(2, "0");
      $('#oilSalesDate').datepicker('setDate', 'yesterday');
      var dt1 = $('#oilSalesDate').datepicker('getDate');
      dt1.setHours(new Date().getHours());
      oilSaleDate = dt1.getFullYear() + "-" + (dt1.getMonth() + 1).toString().padStart(2, "0") + "-" + dt1.getDate().toString().padStart(2, "0");
      setOilSales();


    });


    var ww1 = setInterval(function() {
      if (siteConfiguration == null) {
        clearInterval(ww1);
        initSaleSheet();

        initServiceSalesSheet();
      }
    }, 500);
    var ww = setInterval(function() {
      if (saleDate != null) {

        clearInterval(ww);
        var obj = {
          siteid: user.siteid,
          date: saleDate
        }
        api.call("getSiteConfiguration", function(res) {
          siteConfiguration = res;
          switchTo("changePassword");
          initSalesSheet();
          initServiceSalesSheet();
        }, obj, {});
      }
    }, 100);

    jQuery.validator.addMethod("passwordOk", function(value, element) {
    // allow any non-whitespace characters as the host part
      return (value == user.password);
    }, "");
    validator = $('#passwordChange').validate({
      rules: {
          currentPassword: {
            required: true,
            passwordOk: true
          },
          password: {
            required: true
          },
          confirmPassword: {
            required: true,
            equalTo: "#password"
          }
      },
      messages: {
        currentPassword: {
          required: "Please eneter current password",
          passwordOk: "Current password not valid"
        },
        password: {
          required: "Password is required"
        },
        confirmPassword: {
          required: "Confirm new password",
          equalto: "Passwords does not match"
        }
      },
      validClass: "success",
      highlight: function(element, errorClass, validClass) {
        $(element).removeClass("success");
        $(element).addClass("error");
        $("[target='" + element.id + "']").removeClass("success");
      },
      errorPlacement: function (error, element) {
          $("[target='" + $(element).attr("id") + "']").removeClass("success");
          error.appendTo(element.parent());
          element.removeClass("success");
          element.addClass("error");
      },
      invalidHandler: function(f, v) {

      },
      success: function(label) {
          $("[target='" + $(label).attr("for") + "']").addClass("success");
          if ($(label).html() == "") {
            $(label).remove();
          }
      },
      submitHandler: function(form) {
        var obj = {
          id: user.siteid,
          password: $("#password").val()
        }
        api.call("changePassword", function(res) {
          if (res.status == "ok") {
            swal({
              type: "success",
              text: "Please login with new password"
            }).then((result) => {
              delete localStorage.user;
              window.location.href = "/admin";
            })
          }
        }, obj, {})
      }



    });
    var tOilSales = null;
    function setOilSales() {

      var dEnabled = false;
      var cdt = new Date(oilSaleDate);
      var wdt = new Date(yesterday);
      var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();

      if (sDate && (new Date()).getHours() < 12) {
        dEnabled = true;
      }

      if (tOilSales != null) {
        tOilSales.destroy();
      }
      $("#oilSalesTable").find("tbody").find("tr").remove();

      var $bd = $("#oilSalesTable").find("tbody");
      siteOil = {};
      api.call("getSiteOil", function(res) {
        for (var k in res.records) {
          if (res.records[k].active == "1") {
            siteOil[k] = res.records[k];
          }
        }
        siteOil = _.sortBy(siteOil, "name");
        $.each(siteOil, function() {
          var $tr = $("<tr></tr>");
          $tr.attr("oilid", this.oilid);

          var rcd = null;
          if (!res.sales[this.oilid]) {
            rcd = this;
          } else {
            rcd = res.sales[this.oilid];
          }
          var html = "<td>" + rcd.name + "</td>";
          $(html).appendTo($tr);
          var vl = "";
          if (rcd.start !== undefined) {
            vl = "value='" + rcd.start + "'";
          }

          var html = "<td start><input oilstart onchange='setOilSale(this);' " + vl + " type='number' style='width:100px;' class='form-control' value='0' /></td>";
          $(html).appendTo($tr);

          if (rcd.input!== undefined) {
            vl = "value='" + rcd.input + "'";
          }
          var html = "<td added><input oilinput onchange='setOilSale(this);' " + vl + " type='number' style='width:100px;' class='form-control' value='0' /></td>";
          $(html).appendTo($tr);

          if (rcd.end !== undefined) {
            vl = "value='" + rcd.end + "'";
          }
          var html = "<td end><input " + vl + " oilend onchange='setOilSale(this);' type='number' style='width:100px;' class='form-control' value='' /></td>";
          $(html).appendTo($tr);

          var html = "<td price>" + rcd.price + "</td>";
          $(html).appendTo($tr);

          var html = "<td discount>" + rcd.discount + "</td>";
          $(html).appendTo($tr);

          var sp = rcd.price - (rcd.discount * (rcd.discount / 100));
          var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(sp));
          var html = "<td saleprice='" + sp + "'>" + fmt + "</td>";
          $(html).appendTo($tr);



          if (rcd.sold !== undefined) {
            vl =  rcd.sold;
          } else {
            vl = 0;
          }
          var html = "<td sold>" + vl + "</td>";
          $(html).appendTo($tr);

          if (rcd.value !== undefined) {
            vl = parseFloat(rcd.value);
            vl = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(vl));
          } else {
            vl = "0.00";
          }
          var html = "<td total value='" + ((rcd.value !== undefined) ? rcd.value : "0") + "'>" + vl + "</td>";
          $(html).appendTo($tr);

          if (res.lastsales[this.oilid] !== undefined) {
            $tr.find("[start]").find("input").val(res.lastsales[this.oilid].end);
            $tr.find("[start]").find("input").prop("disabled", true);
          }
          $tr.appendTo($bd);
        });
        tOilSales = $("#oilSalesTable").DataTable();
        tOilSales.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
          var fid = this.data()[0];
          if (!dEnabled && user.user_type == "0") {
            $(this.node()).find("input").prop("disabled", true);
          }
        });
        calculateOilSales();
      }, { date: oilSaleDate, siteid: user.siteid }, {});
    }
    function setOilSale(el) {

      var $tr = $(el).parent().parent();
      var start = parseInt($tr.find("[start]").find("input").val()) + parseInt($tr.find("[added]").find("input").val());
      if (el.value > start && user.user_type == "0") {
        swal({
          type: "error",
          text: "End amount must be less than starting + input amount"
        })
        return false;
      }
      var endv = $tr.find("[end]").find("input").val();
      if (endv == "") {
        var vl = 0;
        var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(vl));
        $tr.find("[total]").html(fmt);
        $tr.find("[total]").attr("value", vl);
      } else {
          var end = parseInt($tr.find("[end]").find("input").val());
          $tr.find("[sold]").html(start - end);
          var prc = parseFloat($tr.find("[saleprice]").attr("saleprice"));
          var vl = prc * (start - end);
          var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(vl));
          $tr.find("[total]").html(fmt);
          $tr.find("[total]").attr("value", vl);
      }
      var obj = {
        date: oilSaleDate,
        siteid: user.siteid,
        oilid: $tr.attr("oilid"),
        start: $tr.find("[start]").find("input").val(),
        input: $tr.find("[added]").find("input").val(),
        end: $tr.find("[end]").find("input").val(),
        sold: $tr.find("[sold]").html(),
        price: $tr.find("[price]").html(),
        discount: $tr.find("[discount]").html(),
        sellprice: $tr.find("[saleprice]").attr("saleprice"),
        value: $tr.find("[total]").attr("value"),
        submitted: 0
      }
      api.call("insertUpdateOilSale", function(res) {
          calculateOilSales();
      }, obj, {});;

    }
    function calculateOilSales() {

      setTimeout(function() {
        var ttl = 0;
          tOilSales.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
            var node = this.node();
            ttl += parseFloat($(node).find("[total]").attr("value"));
          });
          var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(ttl));
          $("[totaloilsales]").html("Total oil & lottery sales: " + fmt);
        }, 10);
    }

    function calculateServiceSale(el) {

      var $el = $(el);
      var total = 0;
      var $tr = $el.closest("tr");
      var start = parseInt($tr.find("td").eq(1).html());
      if ($el.val() < start && user.user_type == "0") {
        swal({
          type: "error",
          text: "Ending value can not be less starting!"
        })
        return;
      }
      if ($el.val() < start && user.user_type == "1") {
        var sold = parseFloat($tr.find("td").eq(2).html());
        var price = parseFloat($tr.find("td").eq(4).html());
        var value = price * sold;
      } else {
        var sold = $el.val() - start;
        var price = parseFloat($tr.find("td").eq(4).html());
        var value = price * sold;
      }


      var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(value);
      var ttl = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(total);
      $tr.find("td").eq(5).html(fmt);
      $tr.find("td").eq(5).attr("total", value);
      $tr.find("td").eq(2).html(sold);
      tableServicesTotal($el.closest("table"));

      var obj = {
        siteid: user.siteid,
        date: serviceSaleDate,
        counterid: $tr.attr("counterid"),
        start: $tr.find("td").eq(1).html(),
        counter: $tr.find("td").eq(2).html(),
        end: $tr.find("td").eq(3).find("input").val(),
        price: price,
        value: value
      }

      api.call("insertOrUpdateServiceSale", function(res) {

      }, obj, {});
    }
    var productsTable = null;
    var pSales = {};
    function setProductSales() {
      var dt = $('#productSaleDate').datepicker('getDate');
      var dEnabled = false;
      var cdt = new Date(productSaleDate);
      var wdt = new Date(yesterday);

      var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();

      if (sDate && (new Date()).getHours() < 12) {
        dEnabled = true;
      }

      pSales = {};
      if (productsTable == null) {
          productsTable = $('#productsTable').DataTable( {
            dom: 'Bfrtip',
            buttons: [
              'excel', 'pdf', 'print',

            ],
            "processing": true,
            "serverSide": true,
            "order": [[ 2, "asc" ]],
            "ajax": url + "products.php",
            "drawCallback": function( settings ) {
              setTimeout(function() {
                productsTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
                  var tr = this.node();
                  var d = this.data();
                  if (pSales[d.id] !== undefined) {
                    d.sales = pSales[d.id]["sales"];
                    var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(pSales[d.id]["sales"]));
                    tr.getElementsByTagName("INPUT")[0].value = fmt;
                  }
                });
              }, 500);
            },
            "columnDefs": [
              {
                'targets': 0,
                'data': "id",
                'visible': false
              },
              {
                'targets': 1,
                'data': "category",
                'visible': false
              },
              {
                'targets': 2,
                'data': "name",
                orderable: true
              },
              {
                'targets': 3,
                'data': "sales",
                orderable: false,
                render: function (data, type, row, meta) {

                    var html = "<input type='text'" + ((!dEnabled && user.user_type == "0") ? "disabled" : "") + " style='width:150px;' value='" + data + "' class='form-control' id='sales' onchange='insertUpdateProductSales(this.parentNode.parentNode);' />";
                    return html;
                }
              },
            ]
          } );
        } else {
          productsTable.ajax.reload( null, false );
        }
        setTimeout(function() {
            productsTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
              if (!dEnabled && user.user_type == "0") {
                $(this.node()).find("input").prop("disabled", true);
              } else {
                $(this.node()).find("input").prop("disabled", false);
              }
            });
          }, 1000);
      var obj = {
        date: productSaleDate,
        siteid: user.siteid
      }
      var data = [];
      api.call("getProductsSales", function(res) {
        pSales = res.records;
        setTimeout(function() {
            productsTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
              var tr = this.node();
              var d = this.data();
              if (res.records[d.id] !== undefined) {
                d.sales = res.records[d.id]["sales"];
                var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(pSales[d.id]["sales"]));
                tr.getElementsByTagName("INPUT")[0].value = fmt;
              }
            });


        }, 5000);
      }, obj, {});
    }
    function insertUpdateProductSales(tr) {
      var $tr = $(tr);
      var obj = {
        date: productSaleDate,
        siteid: user.siteid,
        id: productsTable.row( $tr ).data().id,
        sales: $tr.find("input").val()
      }
      var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat($tr.find("input").val()));
      tr.getElementsByTagName("INPUT")[0].value = fmt;
      api.call("insertUpdateProductSales", function(res) {
        productsTable.row( $tr ).data().sales = obj.sales;
        if (pSales[obj.id] === undefined) {
          pSales[obj.id] = {
            date: productSaleDate,
            siteid: user.siteid,
            productid: obj.id,
            name: "",
            sales: obj.sales
          }
        }
        pSales[obj.id]["sales"] = obj.sales;
      }, obj, {})
    }
    var fdt = null;
    function setFuelDelivery() {
      var dEnabled = false;
      var cdt = new Date(fuelDeliveryDate);
      var wdt = new Date(yesterday);

      var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();
      if (sDate && (new Date()).getHours() < 12) {
        dEnabled = true;
      }

      if (fdt == null) {
          var $bdy = $("#fuelDeliveryTable").find("tbody");
          $.each(tanks, function() {
            var $tr = $("<tr fuelid='" + this.fuelid + "'></tr>");
            $("<td fuelid='" + this.fuelid + "'>" + this.fuelid + "</td>").appendTo($tr);
            $("<td fuelid='" + this.fuelid + "'>" + this.grade + "</td>").appendTo($tr);
            $("<td fuelid='" + this.fuelid + "'><input onchange='updateFuelDelivery(this);' class='form-control' style='width:100px;' value='0' type='number' /></td>").appendTo($tr);
            $tr.appendTo($bdy);
          });
          fdt = $("#fuelDeliveryTable").DataTable({
            columnDefs: [
              { width: 0, targets: 0 },
              { width: 300, targets: 1 },
              { width: 150, targets: 2 },

            ],
            "order": [[ 1, "asc" ]]
          });
          fdt.column( 0 ).visible( false );

      }
      setTimeout(function() {
          fdt.rows().every( function ( rowIdx, tableLoop, rowLoop ) {

            var fid = this.data()[0];
            if (!dEnabled && user.user_type == "0") {
              $(this.node()).find("input").prop("disabled", true);
            } else {
              $(this.node()).find("input").prop("disabled", false);
            }
          });
        }, 1000);
      var obj = {
        date: fuelDeliveryDate,
        siteid: user.siteid
      }
      api.call("getFuelDelivery", function(res) {
        var fls = res.records;
        fdt.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
          var fid = this.data()[0];

          if (fls[fid] !== undefined) {
            this.node().getElementsByTagName("INPUT")[0].value = fls[fid].volume;
          } else {
            this.node().getElementsByTagName("INPUT")[0].value = "0";
          }
        });
      }, obj, {})
  }
  function updateFuelDelivery(el) {
    var tr = el.parentNode.parentNode;
    var obj = {
      date: fuelDeliveryDate,
      siteid: user.siteid,
      fuelid: $(tr).attr("fuelid"),
      volume: el.value
    }
    api.call("insertUpdateFuelDelivery", function(res) {

    }, obj, {})
  }

  var pTable = null;
  function setPayments() {
    var dEnabled = false;
    var cdt = new Date(paymentDate);
    var wdt = new Date(yesterday);

    var sDate = cdt.getFullYear() == wdt.getFullYear() && cdt.getMonth() == wdt.getMonth() && cdt.getDate() == wdt.getDate();

    if (sDate && (new Date()).getHours() < 12) {
      dEnabled = true;
    }

    if (pTable == null) {
        var $bdy = $("#paymentTable").find("tbody");
        $.each(pMethods, function() {
          var $tr = $("<tr paymentid='" + this.id + "'></tr>");
          $("<td paymentid='" + this.id + "'>" + this.id + "</td>").appendTo($tr);
          $("<td paymentid='" + this.id + "'>" + this.name + "</td>").appendTo($tr);
          $("<td paymentid='" + this.id + "'><input onchange='updatePayment(this);' class='form-control' style='width:100px;' value='0' type='text' /></td>").appendTo($tr);
          $tr.appendTo($bdy);
        });
        pTable = $("#paymentTable").DataTable({
          columnDefs: [
            { width: 0, targets: 0 },
            { width: 300, targets: 1 },
            { width: 150, targets: 2 },

          ],
          "order": [[ 1, "asc" ]]
        });
        pTable.column( 0 ).visible( false );

    }
    setTimeout(function() {
        pTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
          if (!dEnabled && user.user_type == "0") {
            $(this.node()).find("input").prop("disabled", true)
          } else {
            $(this.node()).find("input").prop("disabled", false)
          }
        })
      }, 1000);
    var obj = {
      date: paymentDate,
      siteid: user.siteid
    }
    api.call("getPaymentsDone", function(res) {
      var fls = res.records;
      pTable.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
        var fid = this.data()[0];
        if (fls[fid] !== undefined) {
          var fmt = new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(parseFloat(fls[fid].value));
          this.node().getElementsByTagName("INPUT")[0].value = fmt;
        } else {
          this.node().getElementsByTagName("INPUT")[0].value = "0";
        }
      });
    }, obj, {})
  }
  function updatePayment(el) {
    var tr = el.parentNode.parentNode;
    var obj = {
      date: paymentDate,
      siteid: user.siteid,
      id: $(tr).attr("paymentid"),
      value: el.value
    }
    api.call("insertUpdatePayment", function(res) {

    }, obj, {})
  }
  function sendFuel() {
    var valid = true;
    $.each($("[fuelenter]"), function() {
      $(this).removeClass("error");
      if (!(parseInt(this.value) > 0)) {
        valid = false;
        $(this).addClass("error");
      }
    });
    if (!valid) {
      swal({
        type: "error",
        text: "Please enter all sales!"
      })
      return;
    }
    api.call("submitFuelFales", function(res) {

    },{
      date:saleDate,
      siteid: user.siteid
    }, {})
    var docDefinition = {
        content: [
          {text: user.site + ": Fuel sales for " + saleDate, fontSize: 17 },
          {text: "Generated " + (new Date()), fontSize: 10 },
          { text: $("[totalsales]").html(), fontWeight: "bold", margin: [ 0, 5, 10, 0 ]}
        ]
    };
    $.each($("[pump]"), function() {
      docDefinition.content.push(
          { text: $(this).find("h4").html(), fontWeight: "bold", margin: [ 0, 10, 10, 0 ]}
      )
      var tb = [];
      $.each($(this).find("thead").find("tr"), function() {
        var r = [];
        $.each($(this).find("th"), function() {
            r.push($(this).html());
        });
          tb.push(r);
      });

      $.each($(this).find("tbody").find("tr"), function() {
        var r = [];
        $.each($(this).find("td"), function() {
          if ($(this).find("input").length == 0) {
            r.push($(this).html());
          } else {
            r.push($(this).find("input").val());
          }
        })
        tb.push(r);
      });

      docDefinition.content.push(
        {
            layout: 'lightHorizontalLines', // optional
            table: {
              // headers are automatically repeated if the table spans over multiple pages
              // you can declare how many rows should be treated as headers
              headerRows: 1,
               widths: [ '*', '*', '*', '*', '*', '*' ],
              body: tb
            }
        }
      )
    });
    var pdfDocGenerator = pdfMake.createPdf(docDefinition);
    pdfDocGenerator.getBase64((data) => {
        $.ajax({
          url: "mailToAdmin.php",
          type: "POST",
          data: {
            from: user.email,
            pdf: data,
            name: "Fuel_sales_" + (new Date()).getTime() + ".pdf",
            subject: user.site + " Fuel sales " + saleDate,
            text: "Generated " + (new Date())
          },
           success: function() {
             swal({
               type: "success",
               text: "mail sent succesfully"
             })
          }

        })
    });
  }
  function sendOil() {
    var valid = true;
    $.each($("[oilend]"), function() {
      var tr = $(this).closest("tr");
      $(this).removeClass("error");
      if (this.value == "" && (tr.find("[oilstart]").val() != 0 || tr.find("[oilinput]").val() != 0)) {
        $(this).addClass("error");
        valid = false;
      } else {
        $(this).removeClass("error");
      }
    });
    if (!valid) {
      swal({
        type: "error",
        text: "Please enter all sales!"
      })
      return;
    }
    api.call("submitOilSales", function(res) {

    },{
      date: oilSaleDate,
      siteid: user.siteid
    }, {})
    var docDefinition = {
      pageOrientation: 'landscape',
        content: [
          {text: user.site + ": Oil & Lottery sales for " + oilSaleDate, fontSize: 17 },
          {text: "Generated " + (new Date()), fontSize: 10 },
          { text: $("[totaloilsales]").html(), fontWeight: "bold", margin: [ 0, 5, 10, 0 ]}
        ]
    };

      var tb = [];
      $.each($("#oilSalesTable").find("thead").find("tr"), function() {
        var r = [];
        $.each($(this).find("th"), function() {
            r.push($(this).html());
        });
        tb.push(r);
      });

      tOilSales.rows().eq(0).each( function ( index ) {
        var row = tOilSales.row( index );
        var r = [];
        var node = row.node();
        if ($(node).find("[oilstart]").val() > 0 || $(node).find("[oilend]").val() > 0 || $(node).find("[total]").attr("value") != "0") {
            $.each($(node).find("td"), function() {
              if ($(this).find("input").length == 0) {
                r.push($(this).html());
              } else {
                r.push($(this).find("input").val());
              }
            });
            tb.push(r);
          }
      } );

      docDefinition.content.push(
        {
            layout: 'lightHorizontalLines', // optional
            table: {
              // headers are automatically repeated if the table spans over multiple pages
              // you can declare how many rows should be treated as headers
              headerRows: 1,
               widths: [ '*', '*', '*', '*', '*', '*', '*', '*', '*' ],
              body: tb
            }
        }
      )

    var pdfDocGenerator = pdfMake.createPdf(docDefinition);
    pdfDocGenerator.getBase64((data) => {
        $.ajax({
          url: "mailToAdmin.php",
          type: "POST",
          data: {
            from: user.email,
            pdf: data,
            name: "Oil_Lottery_sales_" + (new Date()).getTime() + ".pdf",
            subject: user.site + " Oil & Lottery sales " + saleDate,
            text: "Generated " + (new Date())
          },
           success: function() {
             swal({
               type: "success",
               text: "mail sent succesfully"
             })
          }

        })
    });
  }
  </script>

  </body>
</html>
